<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INCOIS Satellite Map - Full Screen</title>
    {% load static %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { margin: 0; padding: 0; overflow: hidden; }
        .map-controls { 
            position: fixed; 
            top: 10px; 
            right: 10px; 
            z-index: 1000; 
            background: rgba(0,0,0,0.8); 
            padding: 10px; 
            border-radius: 5px; 
        }
        .map-info { 
            position: fixed; 
            bottom: 10px; 
            left: 10px; 
            z-index: 1000; 
            background: rgba(0,0,0,0.8); 
            color: white; 
            padding: 10px; 
            border-radius: 5px; 
            font-size: 12px; 
        }
        iframe { width: 100vw; height: 100vh; border: none; }
    </style>
</head>
<body>
    <!-- Map Controls -->
    <div class="map-controls">
        <div class="btn-group-vertical">
            <button class="btn btn-primary btn-sm" onclick="refreshMap()" title="Refresh">
                <i class="fas fa-sync-alt"></i>
            </button>
            <button class="btn btn-success btn-sm" onclick="toggleAutoRefresh()" id="autoBtn" title="Auto Refresh">
                <i class="fas fa-play" id="autoIcon"></i>
            </button>
            <button class="btn btn-info btn-sm" onclick="toggleFullscreen()" title="Fullscreen">
                <i class="fas fa-expand"></i>
            </button>
            <button class="btn btn-secondary btn-sm" onclick="window.close()" title="Close">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <!-- Map Info -->
    <div class="map-info">
        <div><i class="fas fa-satellite"></i> NOAA Coral Reef Watch</div>
        <div>Last Update: <span id="lastUpdate">{{ "now"|date:"H:i:s" }}</span></div>
        <div>Status: <span id="status">Manual</span></div>
        <div>User: {{ user.username }}</div>
    </div>

    <!-- Satellite Map -->
    <iframe 
        id="satelliteMapFull"
        src="{% if map_config %}{{ map_config.base_url }}?lat={{ map_config.default_lat }}&lng={{ map_config.default_lng }}&zoom_level={{ map_config.default_zoom }}{% else %}https://coralreefwatch.noaa.gov/product/vs/map_full.html?lat=20.5937&lng=78.9629&zoom_level=5{% endif %}"
        allowfullscreen>
    </iframe>

    <script>
    let autoRefreshInterval;
    let isAutoRefreshActive = false;
    const refreshIntervalMs = {% if map_config %}{{ map_config.refresh_interval|default:300 }} * 1000{% else %}300000{% endif %};

    function refreshMap() {
        const iframe = document.getElementById('satelliteMapFull');
        const currentSrc = iframe.src;
        iframe.src = '';
        setTimeout(() => {
            iframe.src = currentSrc + '&t=' + new Date().getTime();
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        }, 100);
    }

    function toggleAutoRefresh() {
        const icon = document.getElementById('autoIcon');
        const btn = document.getElementById('autoBtn');
        const status = document.getElementById('status');
        
        if (isAutoRefreshActive) {
            clearInterval(autoRefreshInterval);
            icon.className = 'fas fa-play';
            btn.className = 'btn btn-success btn-sm';
            status.textContent = 'Manual';
            isAutoRefreshActive = false;
        } else {
            autoRefreshInterval = setInterval(refreshMap, refreshIntervalMs);
            icon.className = 'fas fa-pause';
            btn.className = 'btn btn-warning btn-sm';
            status.textContent = 'Auto';
            isAutoRefreshActive = true;
        }
    }

    function toggleFullscreen() {
        if (document.fullscreenElement) {
            document.exitFullscreen();
        } else {
            document.documentElement.requestFullscreen();
        }
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        if (e.key === 'r' || e.key === 'R') refreshMap();
        if (e.key === 'a' || e.key === 'A') toggleAutoRefresh();
        if (e.key === 'f' || e.key === 'F') toggleFullscreen();
        if (e.key === 'Escape') window.close();
    });

    // Auto-start refresh after 3 seconds
    setTimeout(toggleAutoRefresh, 3000);
    </script>
</body>
</html>